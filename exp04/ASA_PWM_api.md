## 透過ASALIB使用M128上的PWM功能

AVR 的TIMER/COUTER，除了可以使用它的計數計時執行精密計時外。也可以選PWM模式產生數值的三角波計數，替代類比的三角波產生器，與欲輸出之數值比較決定PWM輸出的HI/LO。

M128上共有4個Timer分別為0、1、2、3，而每個Timer都有PWM功能，以下用PWM0、1、2、3代稱。而Timer0、2為8bit，Timer1、3為16bit，並各自擁有不同的輸出腳位，輸出腳位請參考M128之規格書。

---

## 函式呼叫介面

### ASA M128 PWM設定函式

- 呼叫介面：  
  ` char M128_PWM_set( char LSByte, char Mask,char Shift,char Data); `
- 簡介：
  呼叫本函式可執行以下與PWM工作的相關設定工作。依據呼叫目的的不同，可以由後面PWMn設參數表，表到應選用的參數。
   1. PWM的基本時脈選擇：基本時脈決定了PWM波寬時間解析度。
   2. 輸出波前緣或中心對齊選擇：PWM輸出波，前緣與週期對齊或中心與週期中心對齊。
   3. 輸出PWM禁致能：禁能不允許輸出PWM波形，致能可輸出PWM波型
   4. 及HI/LO波寬正比輸入：可選擇PWM輸出HI或LO正比輸入值。
   5. PWM的中斷禁致能：允許或不允許PWM週期產生中斷。
   6. PWM接腳設定輸出方向：設定PWM的波形輸出接腳方向為輸出。
   7. 清除PWM中斷旗標：
- 參數：
   - LSByte : 詳見M128_PWM_set參數快查表
   - Mask   : 詳見M128_PWM_set參數快查表
   - Shift  : 詳見M128_PWM_set參數快查表
   - Data   : 詳見M128_PWM_set參數快查表
- 回傳：  
   - 0 : 成功  
   - 1 : 錯誤：參數不合理。  

#### M128_PWM_set參數快查表

**PWM0 設定參數表**

| 功能 | LSByte | Mask | Shift | Data |
| :-- | :-- | :-- | :-- | :-- |
| 基本時脈選擇 | 214 | 0x08 | 3 | $$Clk_{T0_s} = Clk_{I/O}$$ ：0  <br> $$Clk_{T0_s} = Clk_{OSC}$$ ：1|
| :::         | 215 | 0x07 | 0 | 詳見T/C0來源選擇表 |
| 波前緣或中心對齊選擇 | 215 | 0x48 | 3 | 前緣對齊：9 <br> 中心對齊：8 |
| 輸出PWM禁致能       | 215 | 0x20 | 5 | 禁能：0 <br> 致能：1 |
| 訊號正比HI/LO波寬   | 215 | 0x30 | 4 | 低寬正比：0 <br> 高寬正比：1 |
| PWM中斷禁致能       | 207 | 0x01 | 0 | 禁能：0 <br> 致能：1 |
| 清除PWM中斷旗標     | 208 | 0x01 | 0 | 1 |
| 設定PWM接腳輸出     | 201 | 0x10 | 4 | 1 |

**PWM1 設定參數表**

| 功能 | LSByte | Mask | Shift | Data |
| :-- | :-- | :-- | :-- | :-- |
| 基本時脈選擇        | 218 | 0x07 | 0 | 詳見T/Cn來源選擇表 |
| 波前緣或中心對齊選擇 | 217 | 0x03 | 0 | 前緣對齊：2 <br> 中心對齊：0 |
| :::                | 218 | 0x18 | 3 | 前緣對齊：3 <br> 中心對齊：2 |
| 輸出PWM禁致能       | 217 | 0xA8 | 3 | 禁能：0 <br> 致能：0x15 |
| 訊號正比HI/LO波寬   | 217 | 0x54 | 2 | 低寬正比：0 <br> 高寬正比：0x15 |
| PWM中斷禁致能       | 217 | 0x04 | 2 | 禁能：0 <br> 致能：1 |
| 清除PWM中斷旗標     | 208 | 0x04 | 2 | 1 |
| 設定PWM接腳輸出     | 201 | 0xE0 | 5 | 7 |

**PWM2 設定參數表**

| 功能 | LSByte | Mask | Shift | Data |
| :-- | :-- | :-- | :-- | :-- |
| 基本時脈選擇        | 223 | 0x07 | 0 | 詳見T/Cn來源選擇表 |
| 波前緣或中心對齊選擇 | 223 | 0x48 | 3 | 前緣對齊：9 <br> 中心對齊：8 |
| 輸出PWM禁致能       | 223 | 0x20 | 5 | 禁能：0 <br> 致能：1 |
| 訊號正比HI/LO波寬   | 223 | 0x30 | 4 | 低寬正比：0 <br> 高寬正比：0x15 |
| PWM中斷禁致能       | 207 | 0x40 | 6 | 禁能：0 <br> 致能：1 |
| 清除PWM中斷旗標     | 208 | 0x40 | 6 | 1 |
| 設定PWM接腳輸出     | 201 | 0x80 | 7 | 7 |

**PWM1 設定參數表**

| 功能 | LSByte | Mask | Shift | Data |
| :-- | :-- | :-- | :-- | :-- |
| 基本時脈選擇        | 225 | 0x07 | 0 | 詳見T/Cn來源選擇表 |
| 波前緣或中心對齊選擇 | 224 | 0x03 | 0 | 前緣對齊：2 <br> 中心對齊：0 |
| :::                | 225 | 0x18 | 3 | 前緣對齊：3 <br> 中心對齊：2 |
| 輸出PWM禁致能       | 224 | 0xA8 | 3 | 禁能：0 <br> 致能：0x15 |
| 訊號正比HI/LO波寬   | 224 | 0x54 | 2 | 低寬正比：0 <br> 高寬正比：0x15 |
| PWM中斷禁致能       | 209 | 0x04 | 2 | 禁能：0 <br> 致能：1 |
| 清除PWM中斷旗標     | 210 | 0x04 | 2 | 1 |
| 設定PWM接腳輸出     | 204 | 0x38 | 3 | 7 |

**T/C0 來源選擇Data表**

| Timer基頻 | $$Clk_{T0_S}$$  | $$Clk_{T0_S}/8$$  | $$Clk_{T0_S}/32$$  | $$Clk_{T0_S}/64$$  | $$Clk_{T0_S}/128$$  | $$Clk_{T0_S}/256$$  | $$Clk_{T0_S}/1024$$  |
| :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- |
| Data | 1 | 2 | 3 | 4 | 5 | 6 | 7 |

**T/Cn 來源選擇Data表(n=1,2,3)**

| Timer基頻 | $$Clk_{I/O}$$  | $$Clk_{I/O}/8$$  | $$Clk_{I/O}/64$$  | $$Clk_{I/O}/256$$  | $$Clk_{I/O}/1024$$  | $$T_n$$下緣  | $$T_n$$上緣  |
| :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- |
| Data | 1 | 2 | 3 | 4 | 5 | 非PWM用 | 非PWM用 |

---

### ASA M128_PWM暫存器寫入函式

- 呼叫介面：  
  ` char M128_PWM_put( char LSByte, char Bytes, void *Data_p); `
- 簡介：
  呼叫本函式可執行以下寫入動作
  1. 設定PWM週期總脈波數：每一個週期的基本脈波總數。
  2. 控制輸出PWM的波寬：每一週期輸出的脈波為多少個基本脈波數寬度。
- 參數：
   - LSByte : 詳見M128_PWM_put參數快查表
   - Mask   : 詳見M128_PWM_put參數快查表
   - Shift  : 詳見M128_PWM_put參數快查表
   - Data   : 詳見M128_PWM_put參數快查表
- 回傳：  
   - 0 : 成功  
   - 1 : 錯誤：參數不合理。  

#### M128_PWM_put參數快查表

**PWM 0 每週期總脈波數固定為256個**

| 功能 | LSByte | Bytes | *Data_p(unsigned char) |
| :-- | :-- | :-- | :-- |
| 輸出PWM的波寬 | 0 | 1 | $$0 \leq Duty < 256 $$ |

**PWM1**

| 功能 | LSByte | Bytes | *Data_p(unsigned int) |
| :-- | :-- | :-- | :-- |
| PWM週期總脈波數 | 100 | 2 | $$ N < 2^16 $$ |
| PWM A 輸出波寬 | 2 | 2 | $$ Duty \leq N $$ |
| PWM B 輸出波寬 | 4 | 2 | $$ Duty \leq N $$ |
| PWM C 輸出波寬 | 6 | 2 | $$ Duty \leq N $$ |

**PWM 2 每週期總脈波數固定為256個**

| 功能 | LSByte | Bytes | *Data_p(unsigned char) |
| :-- | :-- | :-- | :-- |
| 輸出PWM的波寬 | 10 | 1 | $$0 \leq Duty < 256 $$ |

**PWM3**

| 功能 | LSByte | Bytes | *Data_p(unsigned int) |
| :-- | :-- | :-- | :-- |
| PWM週期總脈波數 | 100 | 2 | $$ N < 2^16 $$ |
| PWM A 輸出波寬 | 12 | 2 | $$ Duty \leq N $$ |
| PWM B 輸出波寬 | 14 | 2 | $$ Duty \leq N $$ |
| PWM C 輸出波寬 | 16 | 2 | $$ Duty \leq N $$ |

---

### ASA M128_PWM旗標讀取函式

- 呼叫介面：  
  ` char M128_PWM_fgt( char LSByte, char Mask, char Shift, void *Data_p); `
- 簡介：
  呼叫本函式可讀取PWM中斷旗標之值，用於輪詢處理PWM中斷。
- 參數：
   - LSByte : 詳見M128_PWM_fgt參數快查表
   - Mask   : 詳見M128_PWM_fgt參數快查表
   - Shift  : 詳見M128_PWM_fgt參數快查表
   - Data   : 詳見M128_PWM_fgt參數快查表
- 回傳：  
   - 0 : 成功  
   - 1 : 錯誤：參數不合理。  

#### M128_PWM_fgt參數快查表

**PWM0**

| 功能 | LSByte | Mask | Shift | *Data_p(char) |
| :-- | :-- | :-- | :-- | :-- |
| PWM中斷旗標 | 208 | 0x01 | 0 | PWM中斷：1 <br> 無中斷：0 |

**PWM1**

| 功能 | LSByte | Mask | Shift | *Data_p(char) |
| :-- | :-- | :-- | :-- | :-- |
| PWM中斷旗標 | 208 | 0x04 | 2 | PWM中斷：1 <br> 無中斷：0 |

**PWM2**

| 功能 | LSByte | Mask | Shift | *Data_p(char) |
| :-- | :-- | :-- | :-- | :-- |
| PWM中斷旗標 | 208 | 0x40 | 6 | PWM中斷：1 <br> 無中斷：0 |

**PWM3**

| 功能 | LSByte | Mask | Shift | *Data_p(char) |
| :-- | :-- | :-- | :-- | :-- |
| PWM中斷旗標 | 210 | 0x04 | 2 | PWM中斷：1 <br> 無中斷：0 |

---

### ASA M128_PWM中斷服務常式登錄

- 呼叫介面：  
  ` char M128_PWM_isr(char number,char cycle,char phase,void (*function)(void)); `
- 簡介：
  呼叫本函式可將無傳參無回應之函式登錄為PWM週期中斷的服務函式。
- 參數：
    - number：PWM中斷編號，本模組只有四個，編號3:0分別代表
         1. 使用PWM0計數滿溢TOV0中斷函式：Number=0
         2. 使用PWM1計數滿溢TOV1中斷函式：Number=1
         3. 使用PWM2計數滿溢TOV2中斷函式：Number=2
         4. 使用PWM3計數滿溢TOV3中斷函式：Number=3
    - cycle：每一循環中斷次數，每循環執行一次ISR，此值必需為2的指數倍。
    - phase：離每一循環多少次中斷會執行ISR。此值必需小於cycle。
    - (\*function)(void))：先宣告定義出一個無傳參無回應的函式，再取用這個函式的指標住址，做為傳址變數。
- 回傳：  
   - 0 : 成功  
   - 1 : 錯誤：參數不合理。  

---

## 標準使用步驟SOP：

PMW以固定的頻率，輸出可變波寛的正或負脈波。在使用時，決定並設定其固定頻率，正負脈波等工作條件，以及配合PMW頻率調整脈波寬度，是使用上必備的工作要項。

### 決定並設定PWM工作條件：
  1. 脈波對齊選擇及設定：
    - 前緣切齊：做為通訊訊號時適用脈波前緣切齊，接收端可以脈波前緣重置計數器於脈波結束讀取波寬計數值，較易計數波寬。
    - 中心對齊：做為驅動輸出替代或轉換為類比PAM時，以選擇脈波中心對齊週期中心較佳。因為上下緣的出現，會較分散，發射出之無線干擾較小。尤其是三相PWM，其電流切換突波不會集中。
  2. PWM頻率決定及設定：
    - 8位元僅能由PWM基本時脈選擇決定：
      - 前緣對齊PWM：因為每週期只有上數計時，故PWM頻率推得 若有PWM頻率可用計算基本時脈。

      - 中心對齊PWM：因為每週期有上數計數及下數計數，故PWM頻率推得 若有PWM頻率可用計算基本時脈。

    - 16位元則由PWM基本時脈及PWM週期基本時脈總數共同決定：
      - 前緣對齊PWM：因為每週期只有上數計時，故PWM頻率，依據後級切換分辨上限，選擇最快的基本時脈，再計算對應相近的總脈波數。
      - 中心對齊PWM：因為每週期有上數計數及下數計數，故PWM頻率依據後級切換分辨上限，選擇最快的基本時脈，再計算對應相近的總脈波數。
    - 查PWM2設定參數表以基本時脈設定可得LSByte,Bytes,Mask, 查T/C0 T/Cn 來源選擇表可得PWM0,1,2,3最接近基本時脈之Data參數。呼叫，ASA_PWM_set() 函式，可設定相關參數。
    - 查PWM PUT參數表，找出PWM週期基本時脈總數，呼叫ASA_PWM_put()函式完成設定。
  3. 正負脈波選擇及設定：依據輸出後級驅動需求決定。
  4. 登錄PWM中斷服務函式：
    - 依據每多少次中斷會調整一次PWM波寬決定cycle，選定phase=0。執行波寬調整不做任何相位移。
    - 將配合PMW頻率調整脈波寬度副函式登錄為PWM中斷服務函式。
  5. 致能PWM中斷及PWM脈波輸出。

### 配合PMW頻率調整脈波寬度：
  - 呼叫ASA_PWM_put()送出新PWM波寬值。
