## 背景知識1 數位與離散

---

### 以電腦處理類比訊號

對於有上下限的類比訊號, 在有限的誤差容許範圍下，可以用數位訊號來表示。實際上的類比訊號可視為定義域及值域為實數的函數，由於實數的稠密性，自變數\(時間\)及應變數\(訊號\)可能的數值均有無限多個可能值。然而電腦能記載的值為有限個數, 因此不論是自變數或應變數均需由連續性的實數值轉為離散性的數位值, 即所謂的離散化\(Discretize\)。其中在時間軸上的離散化動作稱取樣\(Sampling\)，而訊號離散化則稱為量子化\(Quantumize\)。一個隨時間變動的訊號在取樣及量子化之後即完成了類比轉換數位的動作，成為一串數位數列，數位數列才能夠以電腦來處理。當電腦處理完數位訊號之後，要再送回物理世界作為控制訊號時，則需由取樣的數位數列來猜測取樣時間之間的值，這個過程稱為重建或是數位轉換類比。

### 取樣定理

取樣是對類比訊號時間軸的離散化動作。由於整段時間之中，只取有限的樣本，在樣本之間的訊號便不在離散化的資料之中。這麼一來一定會失去一些資訊。至於那些訊號會失去，可由取樣訊號是否能夠有效的猜測其間未被取到的訊號做為判斷。直覺的觀察，對於平滑緩慢變動的訊號\(低頻訊號\)，要由取樣的訊號來猜測其間的訊號要比猜測劇烈變動的訊號\(高頻訊號\)要容易一些。基於上述的觀察，可以正式的分析如下。

#### 取樣密度不足所造成的後果

上述的高頻或低頻實際上並不很嚴慬，比如說以很快的取樣速率來取高頻的訊號所得到的結果，可能比以很慢的取樣速率對低頻的訊號取樣所得的樣本更加平滑。因此在討論取樣訊號之前，必須另外定義正規化頻率\(Nomalized Frequency\)。


$$
\text{正規化頻率}(Cycle/Sample) = \text{頻率} (Cycle/Second)/ \text{取樣頻率}(Sample/Second)
$$


在數位訊號處理及數位控制之中所稱的頻率其實是正規化頻率，因此同樣一套數位理論可適用於電機或機械，甚至土木工程，僅管從類比訊號分析上電機領域的訊號頻率較高，機械領域較低，而土木結構則最低，但以適當的取樣頻率取樣之後，它們的正規化頻率均應在相近的範圍。圖3-1所示為兩個頻率不同的正弦波，有明顯的差異, 然而以 \* 點取樣之後所得樣本一模一樣，無法分別這兩個不同頻率的正弦波有何不同。其實這類無法分辨的頻率有無限多個，它們組成一個頻域疊影\(Alias\)集合。

\(圖3-1 若取樣於不同弦波的交义點時，無法分辨原訊號為那個弦波\)

如圖3-2類比訊號以傅立葉分析，可以化為一群不同頻率的弦波的線性組合，而這些線性組合係數對頻率的作圖為頻域訊號，當我們以某個取樣頻率取樣時，在頻域相當於是以取樣頻率為圓周長度將原頻域捲成圓桶，而後將圓桶壓扁。這時得到的是一個1/2取樣頻率寬，無限多層的一疊圖形，將每一層的數值加起來即為取樣後的頻域圖。

\(圖3-2訊號取樣，頻域上有如將原訊號捲起壓扁，並把重疊部分加起來\)

由於取樣之後會造成不同頻率訊號相疊加而扭曲原訊號, 因此要避免取樣的扭曲取樣的頻率要夠大，使得捲壓扁的各層中僅有一層有訊號。

取樣除了會使高低頻訊號混雜加成之外，也會使原來週期性的訊號不能維持原週期，甚至變為非週期性：

弦波訊號 $$sin(t+kT)=sin(t) \text{、} K \in N$$



經由$$T_s$$取樣週期取樣後會變成弦波數列$$sin(n)=sin(t)|_{t=nT_s} $$

若存在整數$$m$$使得$$m T_s =k T $$則弦波數列$$sin(n)$$為週期性數列，因為$$$$$$sin(n+m)=sin(t)|_{t=(n+m)T_s} =sin(t)|_{t=nT_s+mT_s} =sin(t)|_{t=nT_s+kT}=sin(t-kT)|_{t=nT_s+kT}=sin(t)|_{t=nT_s}=sin( n )$$

若$$m T_s =k T $$的$$m$$非為整數，

則雖然$$sin(n+m)=sin(t+kT)|_{t+kt=(n+m)T_s}=sin(t)|_{t=nT_s}=sin(n)$$但因$$m$$不為整數，所以若$$sin(n)$$為數列成員，則$$sin(n+m)$$非為數列成員因為$$m+n$$非為整數，不會被取樣到。

這種效應在低頻時並不會有太大困擾, 在高頻時而取樣頻率與週期波頻的倍數又相近時則會造成效果則相當明顯, 參考圖3-3

\(圖3-3取樣頻率不為正弦波頻的倍數時取樣不再是正弦波\)

### 由取樣訊號重建原訊號的極限

除了由頻域上來看取樣頻率的影響之外, 也可以由取樣的訊號是否能重建原訊號來了解取樣過程中資訊流失的問題。 **Shannon**的取樣定律提供了取樣訊號能夠重建原訊號的上限。

#### 取樣定律

假設原訊號在頻域上$$( - \Omega _0 , \Omega _0)$$之外的區域均為零且取樣頻率$$\Omega _s = \frac{1}{T_s}$$ 大於$$2 \Omega _0$$則原訊號在任何時間的訊號大小可以由取樣所得的訊號之線性組合來重建。


$$
f(t) = \sum_{k=-\infty}^{\infty} f(kh) \frac{ sin(w_s(t-kh)/2) }{ w_s(t-kh)/2 } = \sum_{k=-\infty}^{\infty} f(kh) sinc(w_s(t-kh)/2)
$$
觀察上述式中我們可以發現兩個執行訊號重建的困難點,

•  式中有無限多項。

• 式中需要的取樣不但有以前的取樣, 還有未來的取樣。換句話說是不符因果律

由於$$sin(\theta)$$的圖形如圖3-4 兩端數值大小衰減極速，因此取有限項的誤差可以控制在一定範圍之內。至於不合因果律方面，限制了上述重建公式在回饋控制上的使用，但在數位訊號處理上不受因果律之限制，仍能使用。

\(圖3-4 sinc函數\)

雖然Shannon 的公式能提供很好的重建功能, 然而除了受到因果律的限制以及無限項的困擾之外，它所需的計算量也不小。因此一般並不常用，常用的方式是零階保值\(Zero Order Hold\)，以零階的多項式來佔算樣本之間的數值。講白一點零階多項式就是固定數，也就是任何在取樣點之間的訊號都以其左手取樣值為值，如圖3-5。

\(圖3-5零階保值\)

零階保值不必計算，但對樣本間值的猜測顯然會不如Shannon的方法，補救的方式是提高取樣頻率使由原來的$$\Omega>2 \Omega_0$$提高至$$\Omega_x > n \Omega_0，n>2$$通常。提高取樣頻率雖然可以降低零階保值方式的誤差，但誤差終究存在$$e_zoh = max|f(T_s+T_s)|_k = T_smax|f'(t)|_k$$

 誤差間會隨取樣週期$$T_s$$的變小而變小。因此提高取樣頻率將使肇因於零階保值的誤差減小。由於零階保值不是唯一的誤差來源, 在考慮取樣頻率時僅須使零階保值所生誤差不會成為誤差最大來源即可。

### 量子化及數值碼

量子化是對訊號軸的離散動作, 這個動作把原來實數軸上的數值切割為幾段每段給多一個數位值。由於這是一個多對一的對應, 所以無法反向對應, 結果是犧牲一些精確性, 造就一些誤差。

#### 理想量子化ADC曲線, 及反運算DAC曲線

圖3-6為單極性\(Unipolar\)三Bits的ADC曲線，即粗直線部份，以及DAC特性即圓點部份。這個類比轉數位電路的工作電壓範圍是由0V到10V, 由於工作範圍僅有正值沒有負值所以稱作單極性。如果輸入電壓低於0V或高於10V則稱為飽和。由於三Bits可以表示八段數值, 10 V除以8 得到 1.25V是為每個分段的長度, 這長度又稱為LSB \(Least Significan Bits\) 也就是使最小bit變化所需類比值變化量。由圖中可看到原先的類比值一個區域，例如：$$(0,0.625)$$ADC後會對應到數位000單一值，$$(0.625,1.875)$$對應到001。再經由DAC轉換回來也只能對應到單一類比值0及1.25，其中1.25是$$(0.625,1.875)$$區域的中間值。 因此ADC再DAC所對應的類比值並非原本整個實數軸區域, 而是實數中的八個點。換句話說DAC並不是ADC的反函數。因此當類比訊號經由類比轉數位後再經數位轉類比並不會得到原來的數值，而是覆蓋該值區域的中間值，也就是說會產生誤差。例如本例的ADC/DAC對應方式，當DAC取值為ADC同值區域的中值時，其最大誤差為$$1/2LSB$$。

\(圖3-6單極性ADC及DAC曲線\)

由上圖單極性特性曲線，我們看到ADC/DAC的數值碼，000到111，分別代表0到7，它們分別代表的電壓是0V到8.75V。因此ADC/DAC中類比與數位間的轉換公式為$$V = BC \times F_{fr} / 2^b$$，其中$$V$$為類比電壓，$$BC$$為二進制碼binary code，$$V_{fr}$$為動態範圍Full Rang。如果這個二進制碼為8位元，則它的格式在C語言裏是正字元unsigned char 。如果這個二進制碼為16位元，則它的格式在C語言裏是正整數unsigned int。 如果這個二進制碼為32位元，則它的格式在C語言裏是正長整數unsigned long int。因此在執行ADC/DAC時或位元數小於等於8位元，其輸出入變數要用unsigned char 。8以上到16位元要用unsigned int。高於16位元要用unsigned long int。

圖3-7為雙極性三Bits的ADC曲線，即粗直線，及DAC曲線，即黑圓點。當類比訊號包含有正負值時，必需要使用正負雙極性ADC以及DAC。為了維持原值0在ADC後DAC回來時為原值，此處的ADC/DAC曲線安排讓0座落於\(-1.25,1.25\)區域中點。這樣的安排，使得正極含零有100,101,110,111共4個編碼值可用，負值剩下000,001,010,011，4個碼可用。

\(圖3-7雙極性ADC及DAC曲線\)

由上圖雙極性特性曲線，我們看到ADC/DAC的數值碼，000到111，分別代表$$-4$$到$$3$$，它們分別代表的電壓是$$-10V$$到$$7.5V$$。其中$$-4$$到$$3$$，是由$$0$$到$$7$$減掉全幅$$2^{b} = 2^3 = 8$$的一半$$2^{b-1} = 2^2 = 4$$，000 到111代表$$0$$到$$7$$的格式即二進制碼\(binary code\)，$$-4$$到$$3$$是$$0$$到$$7$$平移了半幅$$2^{b-1} = 2^2 = 4$$，被稱做是平移二進制\(shifted binary code\)。雖然平移二進制可以表示正負值，且是ADC/DAC使用的數值碼，但是他在執行運算時並不方便，在C語言也沒有它專用的變數型態，在寫程式時需要借用unsigned char等碼並自行處理平移部份。

在電腦中，最常用可記載正負值數值碼為2補數碼，\(2's compliment code\)。它的定義是，絕對值相同的正負數，兩者互為2的補數，也就是兩者相加為會超過它能夠記載的最大值，並2進位到高一位數。例如3 BITS值，能記錄的值最高為111，進位後為1000。其中負0為$$b1000-b000=b(1)000$$，正1為$$b001$$，負1為$$b100-b001=b111$$，負2為$$b100-b010=b110$$，負3為$$b100-b011=b101$$。

使用2的補數碼有一個特別的好處就是，減掉某值，等於加上某值的負值，因此減法不同特別處理，只要用加法即可。例如$$3-2$$，$$3=b011$$、$$2=b010$$、$$-2=b110$$，$$3-2 = 1 = b001 = b011+b110 = b(1)001$$。在C語言中，2的補數碼是標準碼，char, int, long int都是使用2的補數碼編碼。

當執行雙極性ADC/DAC所用的碼為SBC\(shifted binary code\)，在C語言中是借用unsigned char, unsigned int, unsigned long int型態。而C語言中表達正負\(即雙極性\)的正式型態是2補數碼。因此量測數值\(2補數碼\)，與ADC/DAC數值\(平移二進制\)間的轉換公式為$$V=((int)SBC-2^{b-1})\times V_{fr}/2^b$$，其中為$$V$$類比電壓，$$(int)$$表示轉換型態為int 。$$SBC$$為平移二進制碼shifted binary code ，$$V_{fr}$$為動態範圍Full Rang。

以三BITS，動態範圍$$\pm 10V$$的ADC/DAC為例，$$SBC=b010=2$$對應電壓$$V=((int)SBC-2^{b-1})\times V_{fr}/2^b = \frac{(4-2^2)\times 20}{2^3} = 0 V$$

，$$SBC=b010=2$$對應電壓$$V=\frac{(2-2^2) \times 20}{2^3} = -2 \times 2.5 = -5 V$$，完全吻合特性曲線所示。上述的特性曲線均是理想化的曲線，實際的電路由於電路製作上不可能會百分之百無誤。
